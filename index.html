<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM Monitor Mewah Neon</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEMA NEON / GLOW CYBERPUNK --- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --font-main: 'Roboto Mono', monospace;
            --font-display: 'Orbitron', sans-serif;
            
            /* Palet Neon */
            --neon-blue: #00ffff; /* Cyan/Blue Neon */
            --neon-green: #39ff14; /* Green Neon */
            --neon-pink: #ff10f0; /* Pink Neon */
            --text-light: #f0f0f0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: var(--font-main);
            margin: 0;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 5px var(--neon-blue), 0 0 15px var(--neon-blue);
        }

        /* Status Bar Neon */
        .status-bar {
            font-family: var(--font-display);
            font-weight: 400;
            color: var(--neon-green);
            margin-bottom: 40px;
            font-size: 0.9rem;
            background: rgba(0, 255, 255, 0.05);
            padding: 8px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--neon-green);
            border: 1px solid var(--neon-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            background-color: var(--neon-pink);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--neon-pink);
            transition: all 0.3s ease;
        }

        .connected {
            background-color: var(--neon-green);
            box-shadow: 0 0 8px var(--neon-green);
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1400px;
            margin-bottom: 40px;
        }

        /* Kartu Neon */
        .card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: 0 0 25px var(--neon-blue), inset 0 0 5px var(--neon-blue);
            transform: translateY(-3px);
        }

        .card-title {
            font-family: var(--font-display);
            font-weight: 400;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Nilai Angka Digital */
        .value {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 3.2rem;
            text-align: left;
            margin-bottom: 5px;
            line-height: 1;
            /* Efek Neon */
            text-shadow: 0 0 2px, 0 0 5px;
        }
        
        .unit {
            font-family: var(--font-main);
            font-weight: 400;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.4);
            display: inline-block;
            margin-left: 5px;
        }

        /* Warna Neon Spesifik */
        .voltage .value { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue), 0 0 10px rgba(0, 255, 255, 0.5); }
        .current .value { color: var(--neon-green); text-shadow: 0 0 5px var(--neon-green), 0 0 10px rgba(57, 255, 20, 0.5); }
        .power .value { color: var(--neon-pink); text-shadow: 0 0 5px var(--neon-pink), 0 0 10px rgba(255, 16, 240, 0.5); }
        .energy .value { color: #f9f957; text-shadow: 0 0 5px #f9f957; }
        .freq .value { color: #a78bfa; text-shadow: 0 0 5px #a78bfa; }
        .pf .value { color: #4ecdc4; text-shadow: 0 0 5px #4ecdc4; }

        /* Area Grafik */
        .chart-container {
            width: 100%;
            max-width: 1400px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .chart-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .chart-title {
            font-family: var(--font-display);
            color: var(--neon-blue);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 5px var(--neon-blue);
        }
    </style>
</head>
<body>

    <h1>⚡ NETWORK POWER GRID MONITOR ⚡</h1>
    <div class="status-bar">
        <span id="status-led" class="status-indicator"></span>
        <span>SYSTEM STATUS: <span id="status-text">DISCONNECTED</span></span>
    </div>

    <div class="dashboard">
        <div class="card voltage">
            <div class="card-title">VOLTAGE (AC)</div>
            <div class="value" id="val-voltage">000.0<span class="unit">V</span></div>
        </div>

        <div class="card current">
            <div class="card-title">CURRENT LOAD</div>
            <div class="value" id="val-current">0.000<span class="unit">A</span></div>
        </div>

        <div class="card power">
            <div class="card-title">ACTIVE POWER</div>
            <div class="value" id="val-power">000.0<span class="unit">W</span></div>
        </div>

        <div class="card energy">
            <div class="card-title">TOTAL ENERGY</div>
            <div class="value" id="val-energy">0000<span class="unit">kWh</span></div>
        </div>

        <div class="card freq">
            <div class="card-title">FREQUENCY</div>
            <div class="value" id="val-freq">00.0<span class="unit">Hz</span></div>
        </div>

        <div class="card pf">
            <div class="card-title">POWER FACTOR</div>
            <div class="value" id="val-pf">0.00<span class="unit">Cosφ</span></div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-card">
            <div class="chart-title">Voltage Trend (V)</div>
            <canvas id="voltageChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">Current Trend (A)</div>
            <canvas id="currentChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-title">Power Trend (W)</div>
            <canvas id="powerChart"></canvas>
        </div>
    </div>
    
    <footer>
        <span style="color: var(--neon-pink);">CYBER-IOT MONITORING V1.0</span>
    </footer>

    <script>
        // --- KONFIGURASI MQTT ---
        const mqtt_broker = "broker.emqx.io";
        // Menggunakan WSS (8084) untuk koneksi aman di GitHub Pages (HTTPS)
        const mqtt_port = 8084; 
        const mqtt_topic = "iot/pzem/data101"; // Pastikan topik ini sesuai dengan kode Python Anda
        const client_id = "web_client_neon_" + Math.random().toString(16).substr(2, 8);
        
        // Inisialisasi Paho Client
        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, "/ws", client_id);

        // --- KONFIGURASI CHART.JS ---
        const MAX_DATA_POINTS = 30; // Batasi jumlah titik data untuk 30 detik (jika update 1x/detik)
        let chartData = {
            labels: [],
            voltage: [],
            current: [],
            power: []
        };

        const chartOptions = (color) => ({
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'category',
                    labels: chartData.labels,
                    title: { display: false },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: 'rgba(255, 255, 255, 0.5)', maxRotation: 0, autoSkip: true, maxTicksLimit: 5 }
                },
                y: {
                    beginAtZero: false,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: color, font: { weight: 'bold' } }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            elements: {
                line: { tension: 0.4 },
                point: { radius: 3, backgroundColor: color }
            }
        });

        const voltageChart = new Chart(document.getElementById('voltageChart'), {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Voltage (V)',
                    data: chartData.voltage,
                    borderColor: 'var(--neon-blue)',
                    backgroundColor: 'rgba(0, 255, 255, 0.1)',
                    borderWidth: 2
                }]
            },
            options: chartOptions('var(--neon-blue)')
        });
        
        const currentChart = new Chart(document.getElementById('currentChart'), {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Current (A)',
                    data: chartData.current,
                    borderColor: 'var(--neon-green)',
                    backgroundColor: 'rgba(57, 255, 20, 0.1)',
                    borderWidth: 2
                }]
            },
            options: chartOptions('var(--neon-green)')
        });

        const powerChart = new Chart(document.getElementById('powerChart'), {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Power (W)',
                    data: chartData.power,
                    borderColor: 'var(--neon-pink)',
                    backgroundColor: 'rgba(255, 16, 240, 0.1)',
                    borderWidth: 2
                }]
            },
            options: chartOptions('var(--neon-pink)')
        });


        // --- FUNGSI MQTT ---
        let reconnectTimeout = null;

        client.onConnectionLost = function (responseObject) {
            console.log("Koneksi Hilang: " + responseObject.errorMessage);
            document.getElementById("status-text").innerText = "LOST CONNECTION";
            document.getElementById("status-led").classList.remove("connected");
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connectMQTT, 5000);
        };

        client.onMessageArrived = function (message) {
            try {
                const data = JSON.parse(message.payloadString);
                
                // 1. Update Nilai Statis
                const voltage = parseFloat(data.tegangan);
                const current = parseFloat(data.arus);
                const power = parseFloat(data.daya);
                const energy = parseFloat(data.energi);
                const frek = parseFloat(data.frekuensi);
                const pf = parseFloat(data.pf);

                document.getElementById("val-voltage").innerHTML = voltage.toFixed(1) + '<span class="unit">V</span>';
                document.getElementById("val-current").innerHTML = current.toFixed(3) + '<span class="unit">A</span>';
                document.getElementById("val-power").innerHTML = power.toFixed(1) + '<span class="unit">W</span>';
                document.getElementById("val-energy").innerHTML = energy.toFixed(3) + '<span class="unit">kWh</span>';
                document.getElementById("val-freq").innerHTML = frek.toFixed(1) + '<span class="unit">Hz</span>';
                document.getElementById("val-pf").innerHTML = pf.toFixed(2) + '<span class="unit">Cosφ</span>';

                // 2. Update Grafik Real-Time
                const now = new Date();
                const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                                  now.getMinutes().toString().padStart(2, '0') + ':' + 
                                  now.getSeconds().toString().padStart(2, '0');

                // Tambahkan data baru
                chartData.labels.push(timeLabel);
                chartData.voltage.push(voltage);
                chartData.current.push(current);
                chartData.power.push(power);

                // Hapus data terlama jika melebihi batas
                if (chartData.labels.length > MAX_DATA_POINTS) {
                    chartData.labels.shift();
                    chartData.voltage.shift();
                    chartData.current.shift();
                    chartData.power.shift();
                }

                // Perbarui dan gambar ulang grafik
                voltageChart.update('none');
                currentChart.update('none');
                powerChart.update('none');
                
            } catch (e) {
                console.error("Error parsing JSON atau data tidak valid: ", e);
            }
        };

        function connectMQTT() {
            console.log("Menghubungkan ke MQTT...");
            document.getElementById("status-text").innerText = "CONNECTING...";
            
            client.connect({
                useSSL: true, // TRUE untuk 8084
                onSuccess: function () {
                    console.log("Berhasil Terhubung ke Broker!");
                    document.getElementById("status-text").innerText = "ONLINE (EMQX)";
                    document.getElementById("status-led").classList.add("connected");
                    client.subscribe(mqtt_topic);
                },
                onFailure: function (message) {
                    console.log("Gagal Konek: " + message.errorMessage);
                    document.getElementById("status-text").innerText = "ERROR - Retrying in 5s";
                    document.getElementById("status-led").classList.remove("connected");
                    if (reconnectTimeout) clearTimeout(reconnectTimeout);
                    reconnectTimeout = setTimeout(connectMQTT, 5000);
                }
            });
        }

        window.onload = connectMQTT;
    </script>
</body>
</html>
